<main class="calendar-page" data-controller="calendar">
  <section class="calendar-panel">
    <header class="calendar-panel__header">
      <div>
        <p class="calendar-panel__eyebrow">My Schedule</p>
        <h1>プロジェクト・タスク・習慣をひとつのカレンダーで俯瞰</h1>
        <p class="calendar-panel__lead">日々のルーティンと進行中の仕事をまとめて確認し、今日の優先事項をいつでも思い出せるようにします。</p>
      </div>
      <div class="calendar-panel__actions">
        <%= link_to "今日", root_path, class: "btn" %>
        <div class="month-switcher">
          <%= link_to "&lt;".html_safe, root_path(month: @prev_month_param), class: "btn btn--ghost", aria: { label: "前の月" } %>
          <span><%= @month_label %></span>
          <%= link_to "&gt;".html_safe, root_path(month: @next_month_param), class: "btn btn--ghost", aria: { label: "次の月" } %>
        </div>
      </div>
    </header>

    <% weekdays = ["日", "月", "火", "水", "木", "金", "土"] %>

    <div class="calendar-grid calendar-grid--head">
      <% weekdays.each do |day| %>
        <div class="calendar-weekday"><%= day %></div>
      <% end %>
    </div>

     <div class="calendar-grid" data-calendar-target="grid">
      <% @total_cells.times do |slot| %>
        <% cell_day = slot - @leading_blank_cells + 1 %>
        <% if cell_day.between?(1, @days_in_month) %>
          <% cell_classes = ["calendar-cell"] %>
          <% if @month_date.year == @today.year && @month_date.month == @today.month && cell_day == @today.day %>
            <% cell_classes << "calendar-cell--today" %>
          <% end %>
          <% cell_date = @month_date + (cell_day - 1).days %>
          <% daily_entries = @calendar_entries[cell_date] %>
          <div
            class="<%= cell_classes.join(' ') %>"
            data-calendar-target="cell"
            data-action="click->calendar#select keydown.enter->calendar#select keydown.space->calendar#select"
            data-date-label="<%= cell_date.strftime('%Y年%-m月%-d日') %>"
            data-projects='<%= daily_entries[:projects].to_json %>'
            data-tasks='<%= daily_entries[:tasks].to_json %>'
            data-habits='<%= daily_entries[:habits].to_json %>'
            tabindex="0"
            role="button"
            aria-label="<%= cell_date.strftime('%Y年%-m月%-d日の予定') %>"
          >
            <div class="calendar-date"><%= cell_day %></div>
            <% if daily_entries.values.any?(&:present?) %>
              <ul class="calendar-items">
                <% daily_entries[:projects].each do |project_name| %>
                  <li class="calendar-items__item calendar-items__item--project"><%= project_name %></li>
                <% end %>
                <% daily_entries[:tasks].each do |task_name| %>
                  <li class="calendar-items__item calendar-items__item--task"><%= task_name %></li>
                <% end %>
                <% daily_entries[:habits].each do |habit_name| %>
                  <li class="calendar-items__item calendar-items__item--habit"><%= habit_name %></li>
                <% end %>
              </ul>
            <% end %>
          </div>
        <% else %>
          <div class="calendar-cell calendar-cell--muted"></div>
        <% end %>
      <% end %>
    </div>

    <div class="calendar-detail">
      <h2 data-calendar-target="detailHeading">予定の確認</h2>
      <p>日付を選択すると、登録済みのプロジェクト・タスク・習慣をここに表示します。</p>

      <div class="detail-summary">
        <div class="detail-summary__date" data-calendar-target="detailDate">日付を選択してください</div>
        <p class="detail-summary__empty" data-calendar-target="emptyMessage">登録されている予定はありません。</p>
      </div>

      <div class="detail-columns">
        <div>
          <h3 class="detail-columns__title">プロジェクト</h3>
          <ul class="detail-list" data-calendar-target="projectList"></ul>
        </div>
        <div>
          <h3 class="detail-columns__title">タスク</h3>
          <ul class="detail-list" data-calendar-target="taskList"></ul>
        </div>
        <div>
          <h3 class="detail-columns__title">習慣</h3>
          <ul class="detail-list" data-calendar-target="habitList"></ul>
        </div>
      </div>


      <div class="detail-actions">
         <button type="button" class="detail-button detail-button--project">
          <%= link_to "プロジェクトを登録・確認", projects_path %>
        </button>
         <button type="button" class="detail-button detail-button--task">
          <%= link_to "タスクを登録・確認", tasks_path %>
        </button>
        <button type="button" class="detail-button detail-button--habit">
          <%= link_to "習慣を登録・確認", habits_path %>
        </button>
      </div>
    </div>
  </section>
</main>