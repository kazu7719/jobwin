<main class="calendar-page project-page">
  <% today = Date.current %>
  <% calendar_start = @habits&.minimum(:start_day)&.to_date || today %>
  <% calendar_start = today if calendar_start > today %>
  <% date_headers = (calendar_start..today).to_a %>
  <% weekdays = ["日", "月", "火", "水", "木", "金", "土"] %>

  <section class="calendar-panel project-panel">
    <header class="calendar-panel__header">
      <div>
        <p class="calendar-panel__eyebrow">Habits</p>
        <h1>習慣チェック表</h1>
        <p class="calendar-panel__lead">登録した習慣をカレンダー形式で並べ、チェック状況と進捗率を一覧で確認できます。</p>
      </div>
      <div class="calendar-panel__actions">
        <% if respond_to?(:new_habit_path) %>
          <%= link_to "習慣を登録", new_habit_path, class: "btn" %>
        <% end %>
      </div>
    </header>

    <% grid_template = "minmax(200px, 260px) repeat(#{date_headers.length}, minmax(80px, 1fr))" %>
    <% min_width = 200 + (date_headers.length * 80) %>
    <div class="habit-table" role="table">
      <div class="habit-table__viewport">
        <div class="habit-table__header" role="row" style="grid-template-columns: <%= grid_template %>; min-width: <%= min_width %>px;">
          <div class="habit-table__corner" role="columnheader" aria-label="習慣名"></div>
          <% date_headers.each do |date| %>
            <div class="habit-table__date" role="columnheader">
              <div><%= date.strftime('%m/%d') %></div>
              <small><%= weekdays[date.wday] %></small>
            </div>
          <% end %>
        </div>

        <div class="habit-table__body" role="rowgroup">
          <% if @habits.present? %>
            <% @habits.each do |habit| %>
              <% habit_name = habit.respond_to?(:habit_name) ? habit.habit_name : (habit.respond_to?(:name) ? habit.name : "習慣") %>
              <% start_date = habit.start_day&.to_date %>
              <% day_span = start_date.present? ? [(today - start_date).to_i + 1, 0].max : 0 %>
              <% detail_path = respond_to?(:habit_path) ? habit_path(habit) : "#" %>

              <article class="habit-row" role="row" data-controller="habit-progress" data-habit-progress-total-days-value="<%= [day_span, 0].max %>" style="grid-template-columns: <%= grid_template %>; min-width: <%= min_width %>px;">
                <div class="habit-row__title" role="rowheader">
                  <div class="habit-row__name">
                    <%= link_to habit_name, habit_path(habit.id), class: "project-card__link" %>
                  </div>
                  <div class="habit-row__progress" data-habit-progress-target="progress" aria-live="polite">
                    <%= day_span.positive? ? "0 / #{day_span}日 (0%)" : "開始日を設定してください" %>
                  </div>
                </div>

                <% date_headers.each do |date| %>
                  <% if start_date.present? && date >= start_date %>
                    <label class="habit-row__cell" role="cell">
                      <%= check_box_tag "habit_checks[#{habit.object_id}][]", date, false, data: { action: "change->habit-progress#recalculate", habit_progress_target: "checkbox" } %>
                    </label>
                  <% else %>
                    <div class="habit-row__cell habit-row__cell--muted" role="cell" aria-hidden="true"></div>
                  <% end %>
                <% end %>
              </article>
            <% end %>
          <% else %>
            <div class="habit-row habit-row--empty" role="row" style="grid-template-columns: <%= grid_template %>; min-width: <%= min_width %>px;">
              <p class="habit-card__empty">まだ習慣が登録されていません。習慣を登録して進捗を確認しましょう。</p>
            </div>
          <% end %>
        </div>
      </div>
    </div>
  </section>
</main>